<% body_css_class('FindaRide') %>
<%= javascript_include_tag 'ofi5buc' %>
<%= javascript_include_tag "jquery.ui.map.full.min", "jquery.phonemask" %>
<script src="js/jquery.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<script type="text/javascript">
    $(document).ready(function () {
        $('.contact-form').popupWindow({                                        // jquery for popup window for contact-form
            height:500,
            width:800,
            top:50,
            left:50
        });
        <% if cookies[:contact] && cookies[:contact].to_i == @ride.id %>
            <% if current_user && current_user.messages.where("ride_id = ?", @ride).blank? %>
                $(".message-box").dialog();                                             // jquery for message dailog box message appear
            <% end %>
        <% end %>
        <% if @ride.to_location.present? && @ride.from_location.present? %>               // here check if to and from location of ride present then show the google map by google map jquery
        $('#map_canvas').gmap('displayDirections', { 'origin':'<%= "#{@ride.to_location.name} #{@ride.to_location.google_helper}".strip %>', 'destination':'<%= "#{@ride.from_location.name} #{@ride.from_location.google_helper}".strip %>', 'travelMode':google.maps.DirectionsTravelMode.DRIVING }, { 'panel':document.getElementById('resultstmp') }, function (result, status) {
        });
        <% end %>
        $("#btn-book-ride").click(function () {                                 // for book ride button info view div appear
            $("#btn-book-ride").hide();
            $(".info_view").show();
        });

        $("#new_ride_participant").submit(function () {
            if ($('input#ride_participant_phone').val().length < 1) {
                $(".phone-check1").show();
            }

            else if (!($('input#ride_participant_mode_of_communications_sms_text').is(':checked') || $('#ride_participant_mode_of_communications_phone_call').is(':checked') || $('#ride_participant_mode_of_communications_email').is(':checked'))) {
                $(".method-type-check").show();                   // check no mpde of communication is selected
            }
            else {
                return true;
            }
            return false;
        });

        $("input#ride_participant_mode_of_communications_sms_text").click(function () {
            $(".method-type-check").hide();
        });

        $("#ride_participant_mode_of_communications_phone_call").click(function () {
            $(".method-type-check").hide();
        });

        $("#ride_participant_mode_of_communications_email").click(function () {
            $(".method-type-check").hide();
        });

        $("input#ride_participant_phone").change(function () {
            if ($(this).val() != "")
                $(".phone-check1").hide();
            if ($(this).val().length == 12)
                $(".phone-check").hide();
            if ($(this).val().match(/[0-9]{10}/))
                $(".phone-check2").hide();
        });

        $('input#ride_participant_phone').keypress(function () {
            var string = $(this).val();
            var str1 = $(this).val().length;
            if (str1 == 3)
                $(this).val(string.substring(0, 3) + '-')
            else if (str1 == 7)
                $(this).val(string.substring(0, 7) + '-')
        });

        $("button#contact-info").click(function () {
            //$("button#contact-info").hide();
            // $(".message-box").show();
            $(".message-box").dialog();

        });

        $("input#ride_participant_phone").mask("999-999-9999");                 // jquery for phone number format
        $("#price_tag_1").show();
        $("#ride_participant_number_of_seats").change(function () {
            $(".price_tag").hide();
            $("#price_tag_" + $("#ride_participant_number_of_seats").find("option:selected").val()).show();
        });

        <% if current_user && current_user.mode_of_communications.present?%>
        if (<%=current_user.mode_of_communications == "sms_text"%>)
            $("#ride_participant_mode_of_communications_sms_text").attr("checked", "checked");
        else if (<%=current_user.mode_of_communications == "phone_call"%>)
            $("#ride_participant_mode_of_communications_phone_call").attr("checked", "checked");
        else
            $("#ride_participant_mode_of_communications_email").attr("checked", "checked");
        <%end%>

        <% if current_user && current_user.phone.present?%>
        $("#ride_participant_phone").val("<%=current_user.phone%>");
        <%end%>
    });
</script>

<script>
  $(document).ready(function() {
  $("#costtrip").tooltip({ effect: 'slide'});
	   	   $("#ques_mark").tooltip({ effect: 'slide'});
  });
</script>

<section id="FindaRide" class="Main">

  <!-- #RideSearch -->
  <!-- PostRideBanner -->
  <div class="backbotton">
    <%= link_to "Back to Search Results", "#{search_rides_path}?#{params[:return_url]}", :class => "button post km_click_event_by_text", :id => "A1", :title=>'Back to Search Results' %>
  </div>

  <div class="RidesdetailWrapper">

    <div class="ridesdetail_heading">
      <h3><%= @ride.departure_date.strftime("Departing %A, %B #{@ride.departure_date.day.ordinalize}") %></h3>
      <p>Time Remaining: <span><%= distance_of_time_in_words_to_now(@ride.actual_departure_time) %></span></p>
      <span class="break"></span>
    </div>


    <ul class="RidesList">

      <li>

        <table class="RideDetails">
          <tr>

            <th class="Leave" scope="row"><span class="Icon">Icon</span> Leave:</th>
            <td class="LeaveArriveTime"><strong><%= @ride.departure_time.strftime("%I:%M %p") %></strong></td>
            <td class="PlusMinus">&plusmn; <%= @ride.flexibility_in_minutes %> min.</td>
            <td><strong><%= @ride.from_location && @ride.from_location.name %></strong></td>
          </tr>
          <tr>
            <th class="Arrive" scope="row"><span class="Icon">Icon</span> Arrive:</th>
            <td class="LeaveArriveTime"><strong><%= (@ride.departure_time + @ride.duration_in_minutes.minutes).strftime("%I:%M %p") %></strong></td>
            <td class="PlusMinus">&plusmn; <%= @ride.flexibility_in_minutes %> min.</td>
            <td><strong><%= @ride.to_location && @ride.to_location.name %><span class="SameLocationIcon">Check</span></strong></td>
          </tr>
        </table> <!-- RideDetails -->
        <%= image_tag "cartype_#{@ride.ride_type}.png" %>

        <ul class="UserList">
          <li><p><%= @ride.notes|| 'notes not available...' %></p></li>
          <li class="Arrow">Arrow</li>
        </ul> <!-- UserList -->
      </li> <!-- END OF A RIDE -->





      <!-- END OF A RIDE -->
      <!-- END OF A RIDE -->
      <!-- END OF A RIDE -->
    </ul>

    <div class="trip_map">

      <div class="trip">
        <div class="trip_detail"><h4 id="costtrip">Trip Cost <%= image_tag 'ques_mark.gif' %></h4>
          <div style="position: absolute; top: 35px; left: 498px; opacity: 1; display: none;" class="tooltip"><p><i>Total is calculated by number of seats and total ride price</i></p>
            <span class="TooltipArrow">Arrow</span></div>
          <span class="TooltipArrow"></span>
          <span class="trip_cost"><%= number_to_currency(@ride.price_per_seat) %></span>
          <h4>Service Fee <span>free for a limited time!</span></h4>
          <span class="trip_cost"> 0.00</span>
          <hr>
          <h4>TOTAL</h4>
          <span class="trip_cost answer"><%= number_to_currency(@ride.price_per_seat) %></span>
        </div>



        <div class=" jcarousel-skin-tango">
          <div style="position: relative; display: block;" class="jcarousel-container jcarousel-container-horizontal">

            <% @ride.ride_participants.active_participants.role_wise.each do |rider| %>
              <% if @graph.present? && (rider.user_id != current_user.id) && (current_user.authentications.first.present?) && (rider.user.authentications.first.present?) %>     <!-- check if user login thorough facebook -->
                <% mutual_friends = @graph.get_connections(current_user.authentications.first.uid, "mutualfriends/#{rider.user.authentications.first.uid}") %>                  <!-- fetched mutual friends of current user w.r.t riders -->
                <% @ride.friends_in_common << mutual_friends %>
              <% end %>
            <% end %>

            <% mutual_friends = (@ride.friends_in_common.blank?) ? []:@ride.friends_in_common.flatten.uniq  %>
            <p>Friends in common with riders:</p>
            <div style="position: relative;" class="jcarousel-clip jcarousel-clip-horizontal">
              <ul style="overflow: hidden; position: relative; top: 0px; margin: 0px; padding: 0px; left: 0px; width: 950px;" id="mycarousel" class="jcarousel-list jcarousel-list-horizontal">
                <%  mutual_friends.each do |mf| %>
                  <li jcarouselindex="1" style="float: left; list-style: none outside none;" class="jcarousel-item jcarousel-item-horizontal jcarousel-item-1 jcarousel-item-1-horizontal">
                    <img src="http://graph.facebook.com/<%=friend["id"]%>/picture" alt="" height="34" width="34" />
                  </li>
                <% end %>
                <% if mutual_friends.count==0 %>
                  <li>No common friends found.</li>
                <% end %>
              </ul>
            </div>
            <div disabled="true" style="display: block;" class="jcarousel-prev jcarousel-prev-horizontal jcarousel-prev-disabled jcarousel-prev-disabled-horizontal"></div>
            <div disabled="false" style="display: block;" class="jcarousel-next jcarousel-next-horizontal"></div>
          </div>
        </div>
      </div>


      <div class="form_map"><p>from near <%= @ride.from_location.name %></p>
        <div id="map_canvas" style="height:232px; width: 465px;"></div>
        <script type="text/javascript">
          <% if @ride.to_location.present? && @ride.from_location.present? %>               // here check if to and from location of ride present then show the google map by google map jquery
            $('#map_canvas').gmap('displayDirections', { 'origin':'<%= "#{@ride.to_location.name} #{@ride.to_location.google_helper}".strip %>', 'destination':'<%= "#{@ride.from_location.name} #{@ride.from_location.google_helper}".strip %>', 'travelMode':google.maps.DirectionsTravelMode.DRIVING }, { 'panel':document.getElementById('resultstmp') }, function (result, status) {
            });
          <% end %>
        </script>
      </div>


      <span class="break"></span>
    </div>





    <ul id="about_person">
      <% @ride.ride_participants.active_participants.role_wise.each_with_index do |rider,index| %>
        <li><span class="person_image"><%= image_tag rider.user.user_image_url %></span><p><strong><%= rider.user.full_name %></strong><span class="small_text"> (<%= (index==0)? "organizer" : "passenger" %>)</span><br><i></i></p></li>
      <% end %>


      <% @ride.remaining_seats.times do %>
        <li><span class="person_image">
            <%= image_tag "empty_58-58.jpg" %></span><p><strong>+1 seat open</strong><br><i>Book this ride now!</i></p></li>
      <% end %>
    </ul>




    <% if @ride.active? %>

      <div id="divPrice">
        <% ts = @ride.remaining_seats %>
        <% if ts > 0 %>
          <% if current_user && (@ride.ride_participants.active_participants.pluck(:user_id).include? current_user.id) %>                     <!--check for if the person want to join is own ride -->
            <span>You're already in this ride</span>
          <% else %>






          <% end %>
        </div>
      <% else %>
        <span>Sold out</span>
      <% end %>
    </div>
  <% end %>




  <%= form_for @ride_participant, :url => ride_ride_participants_path(@ride) do |f| %>
    <div class="information_cantainer">
      <h2>Contact Information</h2>
      <div class="inform_form">
        <fieldset><label id="best_number">What number to reach you on?</label>

          <%= f.text_field :phone, :maxlength => "12",:class=>'inform_text' %>
          <%= image_tag "ques_mark.gif", :id=>"ques_mark" %>

          <div style="position: absolute; top: 35px; left: 210px; opacity: 1; display: none;" class="tooltip"><p><i>we do not share your phone number until you and the<br> ride owner have confirmed and accepted</i></p>
            <span class="TooltipArrow" style="left:157px;">Arrow</span></div>
        </fieldset>

        <fieldset>
          <label>Preferred method of communication</label>
          <div class="options">
            <label class="preferred"><%= f.radio_button :mode_of_communications, 'sms_text' %><span class="method_radiotext">SMS Text</span></label>
            <label class="preferred"><%= f.radio_button :mode_of_communications, 'phone_call' %><span class="method_radiotext">Phone Call</span></label>
            <label class="preferred"><%= f.radio_button :mode_of_communications, 'email' %><span class="method_radiotext">Email</span></label></div>
        </fieldset>

        <span class="break"></span>

      </div>
    </div>


    <div class="information_cantainer" >

      <h2>Confirm</h2>
      <ul class="triger_section">

      </ul>
      <span class="break"></span>
      <div class="pay_creditcard" id="paycredit-tab">

        <div class="form_row">


          <div class=" form_row"><fieldset> <input type="submit" class="submit" name="submit" value="Book this Ride Now!"></fieldset><p>By clicking, I agree to the <a href="#">privacy and terms.</a></p></div>
          <span class=" break"></span>

        </div>
        <div class="pay_creditcard" id="paypaypal-tab" style="display:none;">
          <fieldset class="paypal_area">
            <input type="text" class="paypal_feild" value="This payment transacts in $USD. Your total charge is $84." readonly ></fieldset>
          <p  class="paypal_text"><strong>Instructions:</strong><br>
            After clicking "Book it" you will be redirected to PayPal to complete payment.<br>
            <strong>You must complete the process or the transaction will not occur.</strong></p>
          <div class=" form_row"><fieldset> <input type="submit" class="submit useing_paypal" name="submit" value="Book Using PayPal"></fieldset><p>By clicking "Book Using Credit Cards", I agree to the <a href="#">cancellation & refund policy.</a></p></div>
        </div>
      </div>
    </div> <!-- RidesWrapper -->
  <% end %>



</section> <!-- Main #FindaRide -->

<% body_css_class('FindaRide') %>
<%= javascript_include_tag 'ofi5buc' %>
<%= javascript_include_tag "jquery.phonemask" %>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<script type="text/javascript">
  $(document).ready(function () {
  $(".chzn-select").chosen();

  $("#costtrip").tooltip({ effect: 'slide', tip: '#costtrip_tip' });
	$("#ques_mark").tooltip({ effect: 'slide', tip: '#ques_mark_tip'});
  $("input#ride_participant_phone").mask("999-999-9999");                 // jquery for phone number format

  function show_discuss_popup(id)
  {
    $("#popup-"+id).show();
  }

  $(".closed").click(function () {
    $(".post_ride-popup").hide();
  });

  <% if cookies[:contact] && cookies[:contact].to_i == @ride.id %>
    <% if current_user && current_user.messages.where("ride_id = ?", @ride).blank? %>
      $(".post_ride-popup").show();                                             // jquery for message dailog box message appear
    <% end %>
  <% end %>


  });
</script>

<%= render "messages/conversations", contact_me: true, ride: @ride %>

<section id="FindaRide" class="Main">

  <!-- #RideSearch -->
  <!-- PostRideBanner -->
  <div class="backbotton">
    <%= link_to "Back to Search Results", "#{search_rides_path}?#{params[:return_url]}", :class => "button post km_click_event_by_text", :id => "A1", :title=>'Back to Search Results' %>
  </div>

  <div class="RidesdetailWrapper">

    <div class="ridesdetail_heading">
      <h3><%= @ride.departure_date.strftime("Departing %A, %B #{@ride.departure_date.day.ordinalize}") %></h3>
      <p>Time Remaining: <span><%= distance_of_time_in_words_to_now(@ride.actual_departure_time) %></span></p>
      <span class="break"></span>
    </div>


    <ul class="RidesList">

      <li>

        <table class="RideDetails">
          <tr>

            <th class="Leave" scope="row"><span class="Icon">Icon</span> Leave:</th>
            <td class="LeaveArriveTime"><strong><%= @ride.departuredatetime.strftime("%I:%M %p") %></strong></td>
            <td class="PlusMinus">&plusmn; <%= @ride.flexibility_in_minutes %> min.</td>
            <td><strong><%= @ride.from_location && @ride.from_location.name %></strong></td>
          </tr>
          <tr>
            <th class="Arrive" scope="row"><span class="Icon">Icon</span> Arrive:</th>
            <td class="LeaveArriveTime"><strong><%= (@ride.departuredatetime + @ride.duration_in_minutes.minutes).strftime("%I:%M %p") %></strong></td>
            <td class="PlusMinus">&plusmn; <%= @ride.flexibility_in_minutes %> min.</td>
            <td><strong><%= @ride.to_location && @ride.to_location.name %><span class="SameLocationIcon">Check</span></strong></td>
          </tr>
        </table> <!-- RideDetails -->
        <%= image_tag "cartype_#{@ride.ride_type}.png" %>

        <ul class="UserList">
          <li><p><%= @ride.notes|| 'Not ride notes available' %></p></li>
          <li class="Arrow">Arrow</li>
        </ul> <!-- UserList -->
      </li> <!-- END OF A RIDE -->





      <!-- END OF A RIDE -->
      <!-- END OF A RIDE -->
      <!-- END OF A RIDE -->
    </ul>

    <div class="trip_map">

      <div class="trip">


        <div class="trip_detail book_ride">

          <fieldset>
            <label>Availability</label>
            <select style="width: 282px; float: left;" class="chzn-select" name="Select_From" id="selRW5" onchange='$(".total_amount").html($("#selRW5").val());$("#ride_participant_number_of_seats").val($("#selRW5").prop("selectedIndex")+1)'>
              <% (1..@ride.remaining_seats).each do |i| %>
                <option value="<%= number_to_currency(@ride.price_per_seat(i)) %>"><%= i %> seat - <%= number_to_currency(@ride.price_per_seat(i)) %> one-way</option>
              <% end %>
            </select>
          </fieldset>

          <p><a title="How It Works Â»">How It Works »</a><br/>
            <span id="best_number" class="total"><span class="total_amount"><%= number_to_currency(@ride.price_per_seat) %></span> Total</span>
          </p>

          <div class="tooltip" style="position: absolute; top: 35px; left: 498px; opacity: 1; display: none;"><p><i>Total is calculated by number of seats and total ride price</i></p>
            <span style="left: 209px;" class="TooltipArrow">Arrow</span>
          </div>

          <fieldset>
            <input type="submit" value="Book This Ride Now!" class="submit" onclick="$('.book_ride').hide(); $('#trip_cost_slip').show();$('#feedback').hide();$('#form').show();return false;" />
          </fieldset>

        </div>


        <div class="trip_detail" id="trip_cost_slip" style="display:none;" ><h4>Trip Cost <%= image_tag 'ques_mark.gif',:id=>"costtrip" %></h4>
          <div style="position: absolute; top: 35px; left: 498px; opacity: 1; display: none;" class="tooltip" id="costtrip_tip"><p><i>Total is calculated by number of seats and total ride price</i></p>
            <span class="TooltipArrow">Arrow</span></div>
          <span class="TooltipArrow"></span>
          <span class="trip_cost total_amount"><%= number_to_currency(@ride.price_per_seat) %></span>
          <h4>Service Fee <span>free for a limited time!</span></h4>
          <span class="trip_cost"> 0.00</span>
          <hr />
          <h4>TOTAL</h4>
          <span class="trip_cost answer total_amount"><%= number_to_currency(@ride.price_per_seat) %></span>
        </div>
<div style="clear:both"></div>
<%= render :partial=>'friend_in_common' %>
      </div>


      <%= render :partial=>'gmap'  %>


      <span class="break"></span>
    </div>





    <ul id="about_person">
      <% @ride.ride_participants.active_participants.role_wise.each_with_index do |rider,index| %>
        <li><span class="person_image"><%= image_tag rider.user.user_image_url %></span><p><strong><%= rider.user.full_name %></strong><span class="small_text"> (<%= (index==0)? "organizer" : "passenger" %>)</span><br>
            <% if index==0 %><i><a class="contact-me" href="#">contact me!</a></i><% end %> </p></li>
      <% end %>


      <% @ride.remaining_seats.times do %>
        <li><span class="person_image">
            <%= image_tag "empty_58-58.jpg" %></span><p><strong>+1 seat open</strong><br><i>Book this ride now!</i></p></li>
      <% end %>
    </ul>




    <% if @ride.active? %>
      <div id="divPrice">
        <% ts = @ride.remaining_seats %>
        <% if ts > 0 %>
          <% if current_user && (@ride.ride_participants.active_participants.pluck(:user_id).include? current_user.id) %>                     <!--check for if the person want to join is own ride -->
            <span>You're already in this ride</span>
          <% else %>
            <div class="information_cantainer" id="feedback">
              <h3>Feedback</h3>
              <ul id="reviews">
                <% if @ride.owner.feedbacks.count==0 %>
                  <li><p>No Feedback</p></li>
                <% end %>
                <% @ride.owner.feedbacks.each do |feedback| %>
                  <li>
                    <span class="person_image">
                      <%= image_tag feedback.owner.user_image_url %>
                    </span>
                    <div class="feed_text">
                      <h4><% "(#{feedback.owner.city})" unless feedback.owner.city.blank? %> <%= feedback.owner.full_name %> <span class="thumb">says:</span></h4>
                      <p><%= feedback.feedback %></p></div>
                    <span class="break"></span>
                  </li>
                <% end %>

              </ul>
              <span class="break"></span>
            </div>
            <div id="form" style="display:none;">
              <%= render :partial=>'form' %>
            </div>
          <% end %>
        </div>
      <% else %>
        <span>Sold out</span>
      <% end %>
    <% end %>

  </div>


</section> <!-- Main #FindaRide -->
